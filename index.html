<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" type="text/css" href="style.css">

    <script  src="require.js"></script>
    <script>
        requirejs.config({
            baseUrl: 'build'
        });

        requirejs(['build/WebGLTS.js'], function(webgl) 
        {
            webgl.start();

            //Project stats
            setInterval(function()
            {   
                var stats = webgl.getStats();

                document.getElementById("fps").innerHTML = stats.fps;
                document.getElementById("deltaTime").innerHTML = stats.deltaTime;
                document.getElementById("time").innerHTML = stats.time;
                document.getElementById("objects").innerHTML = stats.objects;
                document.getElementById("vertices").innerHTML = stats.vertices;
            }, 10);

            var gameObjects = webgl.getGameObjects();
            var inspectorInterval = function(){};
            var eventObject;
            var info = {};

            hierarchyBody.innerHTML = '';
            
            for (var i = 0; i < gameObjects.length; i++)
            {
                (function () {
                    var index = i;
                    var tr = document.createElement("tr");
                    tr.setAttribute("id", gameObjects[i].id);
                    var td = document.createElement("td");
                    var text = document.createTextNode(gameObjects[i].name);

                    tr.appendChild(td);
                    td.appendChild(text);

                    //Add inspector 
                    td.addEventListener("click", function(event) 
                    { 
                        if (eventObject != null) 
                        {
                            eventObject.classList.remove("active");
                        }

                        eventObject = event.target;
                        eventObject.classList.add('active');

                        for (var i = 0; i < gameObjects[index].components.length; i++)
                            gameObjects[index].components[i].GenerateInspectorDOM();

                        removeEventListener("posX");
                        document.getElementById("posX").addEventListener("input", function(event) { 
                            webgl.setGameObjectPosition(index, event.target.value, info.position.y, info.position.z);
                        });

                        removeEventListener("posY");
                        document.getElementById("posY").addEventListener("input", function(event) { 
                            webgl.setGameObjectPosition(index, info.position.x, event.target.value, info.position.z);
                        });

                        removeEventListener("posZ");
                        document.getElementById("posZ").addEventListener("input", function(event) { 
                            webgl.setGameObjectPosition(index, info.position.x, info.position.y, event.target.value);
                        });

                        removeEventListener("scaleX");
                        document.getElementById("scaleX").addEventListener("input", function(event) { 
                            webgl.setGameObjectScale(index, event.target.value, info.scale.y, info.scale.z);
                        });

                        removeEventListener("scaleY");
                        document.getElementById("scaleY").addEventListener("input", function(event) { 
                            webgl.setGameObjectScale(index, info.scale.x, event.target.value, info.scale.z);
                        });

                        removeEventListener("scaleZ");
                        document.getElementById("scaleZ").addEventListener("input", function(event) { 
                            webgl.setGameObjectScale(index, info.scale.x, info.scale.y, event.target.value);
                        });

                        /*removeEventListener("colorR");
                        document.getElementById("colorR").addEventListener("input", function(event) { 
                            webgl.setGameObjectColor(index, event.target.value, info.color.g, info.color.b);
                        });

                        removeEventListener("colorG");
                        document.getElementById("colorG").addEventListener("input", function(event) { 
                            webgl.setGameObjectColor(index, info.color.r, event.target.value, info.color.b);
                        });

                        removeEventListener("colorB");
                        document.getElementById("colorB").addEventListener("input", function(event) { 
                            webgl.setGameObjectColor(index, info.color.r, info.color.g, event.target.value);
                        });*/

                        clearInterval(inspectorInterval);
                        inspectorInterval = setInterval( function() { inspectorInfo(index); }, 10 ); 
                    });

                    document.getElementById("hierarchyBody").appendChild(tr); 
                }());
            }    

            function inspectorInfo (i) 
            {
                info = webgl.getGameObjectInfo(i);
                document.getElementById("name").innerHTML = info.name;
                document.getElementById("rotation").innerHTML = info.rotation.toString();
                document.getElementById("shader").innerHTML = info.shader.name;

                //PositionInspector
                if (document.activeElement.id !== "posX")
                    document.getElementById("posX").value = info.position.x;
                
                if (document.activeElement.id !== "posY")
                    document.getElementById("posY").value = info.position.y;

                if (document.activeElement.id !== "posZ")
                    document.getElementById("posZ").value = info.position.z;

                //ScaleInspector
                if (document.activeElement.id !== "scaleX")
                    document.getElementById("scaleX").value = info.scale.x;
                
                if (document.activeElement.id !== "scaleY")
                    document.getElementById("scaleY").value = info.scale.y;

                if (document.activeElement.id !== "scaleZ")
                    document.getElementById("scaleZ").value = info.scale.z;

                //ColorInspector
                /*if (document.activeElement.id !== "colorR")
                    document.getElementById("colorR").value = info.color.r;
                
                if (document.activeElement.id !== "colorG")
                    document.getElementById("colorG").value = info.color.g;

                if (document.activeElement.id !== "colorB")
                    document.getElementById("colorB").value = info.color.b;*/
            }

            function removeEventListener(id) 
            {
                //var old_element = document.getElementById(id);
                //var new_element = old_element.cloneNode(true);
                //old_element.parentNode.replaceChild(new_element, old_element);
            }
        });
    </script>

    <title>WebGL - Typescript</title>
</head>
<body>
    <div class="container" style="width:1200px">
        <div style="float:left;width:70%">
            
            <!-- Project stats -->
            <div id="info" >
                <table class="table">
                    <thead>
                        <tr>
                            <th>FPS</th>
                            <th>Deltatime</th>
                            <th>Gametime</th>
                            <th>Objects</th>
                            <th>Vertices</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="fps"></td>
                            <td id="deltaTime"></td>
                            <td id="time"></td>
                            <td id="objects"></td>
                            <td id="vertices"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- WebGL canvas -->
            <div id="gameView">
                <canvas id="glcanvas" width="840" height="480" style="background: red;">
                    Your browser doesn't appear to support the 
                    <code>&lt;canvas&gt;</code> element.
                </canvas>
            </div>

            <!-- Inspector -->
            <fieldset id="inspector" class="inspector">
                <legend>Inspector: <span id="name"></span></legend>

                <div id="fuckyou"></div>

                <div style="float:left;width:10%;">
                    <label for="shader">Shader </label>
                </div>
                <div style="float:left;width:90%;">
                    <p id="shader"></p>
                </div>

                <div id="fuckme"></div>
            </fieldset>
        </div>

        <!-- Hierachy of scene -->
        <div id="hierarchy" class="scrollable-y" style="float:left;width:30%;">
            <table class="table selectable">
                <thead>
                    <tr>
                        <th>Hiearachy</th>
                    </tr>
                </thead>
                <tbody id="hierarchyBody">
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>